<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Trustworthy Product Reviews</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    <link rel="stylesheet" href="css/index.css" />
</head>
<body>
<div class="container">
    <h1>Trustworthy Product Reviews</h1>

    <div id="gate">Checking sign-in…</div>

    <div id="authed" style="display:none;">
        <h2 id="welcome"></h2>
        <p id="whoami"></p>
        <a id="logout" href="/.auth/logout">Logout</a>
    </div>

    <div id="error" style="display:none;color:#b00020;">
        <p>We couldn’t verify your session. Please refresh the page.</p>
    </div>
</div>

<script>
    (async () => {
      const gate = document.getElementById('gate');
      const authed = document.getElementById('authed');
      const welcome = document.getElementById('welcome');
      const whoami = document.getElementById('whoami');
      const err = document.getElementById('error');

      try {
        // Azure Easy Auth guarantees /products.html is reached only after sign-in
        const res = await fetch('/.auth/me', { credentials: 'include', cache: 'no-store' });
        if (!res.ok) throw new Error('auth failed');

        const data = await res.json();
        const claims = data?.[0]?.user_claims ?? [];
        const name =
          (claims.find(c => c.typ.endsWith('/name')) || {}).val ||
          (claims.find(c => c.typ.endsWith('/emailaddress')) || {}).val ||
          data?.[0]?.user_id || 'User';
        const email = (claims.find(c => c.typ.endsWith('/emailaddress')) || {}).val || '';

        welcome.textContent = `Welcome, ${name}!`;
        whoami.textContent = `Signed in as ${email || name}`;
        authed.style.display = 'block';
      } catch (e) {
        err.style.display = 'block';
      } finally {
        gate.style.display = 'none';
      }
    })();
</script>
</body>
</html>
